#!/usr/bin/env node

require("babel/register");
var argv = require('minimist')(process.argv);
var Server = require('../src/server').Server;
var config = require('../src/config').config(process.env, argv);
var PORT = process.env.PORT || 5000;

if (process.env.NEW_RELIC_LICENSE_KEY) {
  console.warn('starting newrelic with key: ', process.env.NEW_RELIC_LICENSE_KEY);
  require('newrelic');
}

console.warn("Starting on PORT " + PORT);
const server = Server(config);
server.listen(PORT);

function exitNow() {
  console.warn("Exiting now !");
  process.exit();
}

function handleExit() {
  console.log("Exiting... waiting 30 seconds workers to flush");
  setTimeout(exitNow, 30000);
  server.exit().then(exitNow);
}

process.on("SIGINT", handleExit);
process.on("SIGTERM", handleExit);

